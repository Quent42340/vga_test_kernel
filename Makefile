#-------------------------------------------------------------------------------
TARGET		= myos
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
AS			= nasm
CC			= i686-elf-gcc
CXX			= i686-elf-g++
LD			= $(CC)
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
ASDIR		= asm
SRCDIR		= source
INCDIR		= include
CONFDIR		= conf
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
COMMONFLAGS	= -ffreestanding -O2 -Wall -Wextra -masm=intel -MD

ASFLAGS		= -felf32
CFLAGS		= $(COMMONFLAGS) -std=gnu99
CXXFLAGS	= $(COMMONFLAGS) -std=c++11 -fno-exceptions -fno-rtti
LDFLAGS		= $(COMMONFLAGS) -nostdlib -lgcc

CFLAGS		+= -I$(INCDIR)
CXXFLAGS	+= -I$(INCDIR)
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
ASFILES		= $(wildcard $(ASDIR)/*.s)
CFILES		= $(wildcard $(SRCDIR)/*c)
CPPFILES	= $(wildcard $(SRCDIR)/*cpp)
LDFILE		= $(CONFDIR)/linker.ld

OFILES		= $(ASFILES:.s=.o) $(CFILES:.c=.o) $(CPPFILES:.cpp=.o)
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
all: $(TARGET).bin
#-------------------------------------------------------------------------------
	@echo "Done for $(notdir $<)"

#-------------------------------------------------------------------------------
$(TARGET).bin: $(OFILES) $(LDFILE)
#-------------------------------------------------------------------------------
	@echo "Linking..."
	@$(LD) -T $(LDFILE) -o $(TARGET).bin $(OFILES) $(LDFLAGS)

#-------------------------------------------------------------------------------
%.o: %.s
#-------------------------------------------------------------------------------
	@echo "=>" $(notdir $<)
	@$(AS) $(ASFLAGS) $< -o $@

#-------------------------------------------------------------------------------
%.o: %.c
#-------------------------------------------------------------------------------
	@echo "=>" $(notdir $<)
	@$(CC) $(CFLAGS) -c $< -o $@

#-------------------------------------------------------------------------------
%.o: %.cpp
#-------------------------------------------------------------------------------
	@echo "=>" $(notdir $<)
	@$(CXX) $(CXXFLAGS) -c $< -o $@

#-------------------------------------------------------------------------------
run: all
#-------------------------------------------------------------------------------
	@echo "Running..."
	@qemu-system-i386 -kernel myos.bin

#-------------------------------------------------------------------------------
iso:
#-------------------------------------------------------------------------------
	@echo "Making iso..."
	@mkdir -p iso/boot/grub
	@cp $(TARGET).bin iso/boot/
	@cp conf/grub.cfg iso/boot/grub
	@grub-mkrescue -o $(TARGET).iso iso
	@rm -rf iso
	@echo "Done."

#-------------------------------------------------------------------------------
clean:
#-------------------------------------------------------------------------------
	@rm -f $(OFILES)

#-------------------------------------------------------------------------------
fclean: clean
#-------------------------------------------------------------------------------
	@rm -f $(TARGET).bin

#-------------------------------------------------------------------------------
re: fclean all
#-------------------------------------------------------------------------------

-include *.d

.PHONY: run iso clean fclean re
